{{config(
    unique_key='LOC_ID', 
    tags=["loc"]
    ,pre_hook=mpre_hook(c_package="LOC", c_status="RUNNING", c_bookmark="AFTER_TMP")
)}}

with using_clause as 
(
    SELECT 
        {{dbt_utils.generate_surrogate_key(['LOC_ID','LOC_DESC'])}} as LOC_KEY,
        LOC_ID,
        LOC_DESC,
        DST_KEY,
        DST_ID,
        DST_DESC,
        RGN_KEY,
        RGN_ID,
        RGN_DESC,
        ARA_KEY,
        ARA_ID,
        ARA_DESC,
        CHN_KEY,
        CHN_ID,
        CHN_DESC,
        CHNL_KEY,
        CHNL_ID,
        CHNL_DESC,
        COMPANY_KEY,
        COMPANY_ID,
        COMPANY_DESC,
        CNCY_CDE,
        LOC_TYP_CDE,
        LOC_TYP_CDE_DESC,
        STR_TYP_CDE,
        STR_TYP_CDE_DESC,
        LOC_STATE_CDE,
        LOC_STATE_CDE_DESC,
        LOC_COUNTRY_CDE,
        LOC_COUNTRY_CDE_DESC,
        LOC_FMT_CDE,
        LOC_FMT_CDE_DESC,
        TSF_ZONE_CDE,
        TSF_ZONE_CDE_DESC,
        LOC_UPS_DST,
        LOC_VAT_RGN,
        LOC_STKHLD_IND,
        LOC_VAT_INCLUDE_IND,
        LOC_BREAK_PACK_IND,
        LOC_PHY_WH_NUM,
        LOC_VIRTUAL_WH_NUM,
        LOC_DEFAULT_WH_NUM,
        LOC_LAST_REMODEL_DT,
        LOC_START_DT,
        LOC_END_DT,
        RMS_LOAD_DATE,
        RMS_Q_DC_ID,
        RMS_Q_STR_DC_FLG,
        RMS_Q_STR_SLS_SQFT,
        RMS_ORG_HIER_TYPE,
        RMS_Q_STR_SELLING_FLG,
        RMS_Q_STR_DNUM,
        RMS_Q_STR_ADDR2,
        RMS_Q_STR_SDESC,
        RMS_Q_STR_STATUS,
        RMS_Q_STR_CITY,
        RMS_Q_STR_LATI,
        RMS_Q_STR_GRD,
        RMS_Q_STR_ZIP,
        RMS_CLIMATE,
        RMS_SRC_ID,
        RMS_Q_STR_ADDR1,
        RMS_PROTECTED_IND,
        RMS_Q_STR_CMP_DT,
        RMS_VOLUME,
        RMS_TOTAL_SQUARE_FT,
        RMS_WH_ADD1,
        RMS_TIER

    FROM {{ref('TMP_D_ORG_LOC_LU')}}

),

updates as
(
    SELECT 
        LOC_KEY,
        LOC_ID,
        LOC_DESC,
        DST_KEY,
        DST_ID,
        DST_DESC,
        RGN_KEY,
        RGN_ID,
        RGN_DESC,
        ARA_KEY,
        ARA_ID,
        ARA_DESC,
        CHN_KEY,
        CHN_ID,
        CHN_DESC,
        CHNL_KEY,
        CHNL_ID,
        CHNL_DESC,
        COMPANY_KEY,
        COMPANY_ID,
        COMPANY_DESC,
        CNCY_CDE,
        LOC_TYP_CDE,
        LOC_TYP_CDE_DESC,
        STR_TYP_CDE,
        STR_TYP_CDE_DESC,
        LOC_STATE_CDE,
        LOC_STATE_CDE_DESC,
        LOC_COUNTRY_CDE,
        LOC_COUNTRY_CDE_DESC,
        LOC_FMT_CDE,
        LOC_FMT_CDE_DESC,
        TSF_ZONE_CDE,
        TSF_ZONE_CDE_DESC,
        LOC_UPS_DST,
        LOC_VAT_RGN,
        LOC_STKHLD_IND,
        LOC_VAT_INCLUDE_IND,
        LOC_BREAK_PACK_IND,
        LOC_PHY_WH_NUM,
        LOC_VIRTUAL_WH_NUM,
        LOC_DEFAULT_WH_NUM,
        LOC_LAST_REMODEL_DT,
        LOC_START_DT,
        LOC_END_DT,
        RMS_LOAD_DATE,
        RMS_Q_DC_ID,
        RMS_Q_STR_DC_FLG,
        RMS_Q_STR_SLS_SQFT,
        RMS_ORG_HIER_TYPE,
        RMS_Q_STR_SELLING_FLG,
        RMS_Q_STR_DNUM,
        RMS_Q_STR_ADDR2,
        RMS_Q_STR_SDESC,
        RMS_Q_STR_STATUS,
        RMS_Q_STR_CITY,
        RMS_Q_STR_LATI,
        RMS_Q_STR_GRD,
        RMS_Q_STR_ZIP,
        RMS_CLIMATE,
        RMS_SRC_ID,
        RMS_Q_STR_ADDR1,
        RMS_PROTECTED_IND,
        RMS_Q_STR_CMP_DT,
        RMS_VOLUME,
        RMS_TOTAL_SQUARE_FT,
        RMS_WH_ADD1,
        RMS_TIER,
        CURRENT_TIMESTAMP as RCD_INS_TS,
        CURRENT_TIMESTAMP as RCD_UPD_TS,
        0 as RCD_CLOSE_FLG,
        '9999-12-31' as RCD_CLOSE_DT

    FROM using_clause
 
    {% if is_incremental() %}
    where LOC_ID in (SELECt LOC_ID from {{this}})
    {% endif %}
),

inserts as
(
    SELECT 
        LOC_KEY,
        LOC_ID,
        LOC_DESC,
        DST_KEY,
        DST_ID,
        DST_DESC,
        RGN_KEY,
        RGN_ID,
        RGN_DESC,
        ARA_KEY,
        ARA_ID,
        ARA_DESC,
        CHN_KEY,
        CHN_ID,
        CHN_DESC,
        CHNL_KEY,
        CHNL_ID,
        CHNL_DESC,
        COMPANY_KEY,
        COMPANY_ID,
        COMPANY_DESC,
        CNCY_CDE,
        LOC_TYP_CDE,
        LOC_TYP_CDE_DESC,
        STR_TYP_CDE,
        STR_TYP_CDE_DESC,
        LOC_STATE_CDE,
        LOC_STATE_CDE_DESC,
        LOC_COUNTRY_CDE,
        LOC_COUNTRY_CDE_DESC,
        LOC_FMT_CDE,
        LOC_FMT_CDE_DESC,
        TSF_ZONE_CDE,
        TSF_ZONE_CDE_DESC,
        LOC_UPS_DST,
        LOC_VAT_RGN,
        LOC_STKHLD_IND,
        LOC_VAT_INCLUDE_IND,
        LOC_BREAK_PACK_IND,
        LOC_PHY_WH_NUM,
        LOC_VIRTUAL_WH_NUM,
        LOC_DEFAULT_WH_NUM,
        LOC_LAST_REMODEL_DT,
        LOC_START_DT,
        LOC_END_DT,
        RMS_LOAD_DATE,
        RMS_Q_DC_ID,
        RMS_Q_STR_DC_FLG,
        RMS_Q_STR_SLS_SQFT,
        RMS_ORG_HIER_TYPE,
        RMS_Q_STR_SELLING_FLG,
        RMS_Q_STR_DNUM,
        RMS_Q_STR_ADDR2,
        RMS_Q_STR_SDESC,
        RMS_Q_STR_STATUS,
        RMS_Q_STR_CITY,
        RMS_Q_STR_LATI,
        RMS_Q_STR_GRD,
        RMS_Q_STR_ZIP,
        RMS_CLIMATE,
        RMS_SRC_ID,
        RMS_Q_STR_ADDR1,
        RMS_PROTECTED_IND,
        RMS_Q_STR_CMP_DT,
        RMS_VOLUME,
        RMS_TOTAL_SQUARE_FT,
        RMS_WH_ADD1,
        RMS_TIER,
        CURRENT_TIMESTAMP as RCD_INS_TS,
        CURRENT_TIMESTAMP as RCD_UPD_TS,
        0 as RCD_CLOSE_FLG,
        '9999-12-31' as RCD_CLOSE_DT

    FROM using_clause
    where LOC_ID not in (select LOC_ID from updates)
)


select * from updates {% if is_incremental() %} union SELECT * FROM inserts {% endif %} 
